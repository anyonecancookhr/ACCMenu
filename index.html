<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advance Order Form & Menus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase logging to Debug for visibility
        setLogLevel('Debug');

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = null;
        let isAuthReady = false;

        // Initialize Firebase and Authentication
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            window.db = db; // Attach to window for global access in script

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                } else {
                    // Sign in anonymously if no token is provided (or token fails)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        userId = auth.currentUser.uid;
                    } else {
                        await signInAnonymously(auth);
                        userId = auth.currentUser.uid;
                    }
                }
                isAuthReady = true;
                document.getElementById('user-id-display').textContent = userId;
                console.log("Firebase Auth Ready. User ID:", userId);
                // After auth is ready, initialize app logic that depends on userId
                window.setupAppLogic(userId);
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('app-status').textContent = 'Firebase Error: Check console.';
        }

        // --- Core Application Logic (must be attached to window for use outside module) ---

        const menus = [
            {
                vendor: "Goffa",
                files: [
                    "Goffa_Boxed_Orders-images-0.jpg", "Goffa_Boxed_Orders-images-1.jpg", "Goffa_Boxed_Orders-images-2.jpg",
                    "Goffa_Boxed_Orders-images-3.jpg", "Goffa_Boxed_Orders-images-4.jpg", "Goffa_Boxed_Orders-images-5.jpg"
                ]
            },
            {
                vendor: "Purple Oven",
                files: [
                    "PO_Menu-images-0.jpg", "PO_Menu-images-1.jpg", "PO_Menu-images-2.jpg", "PO_Menu-images-3.jpg",
                    "PO_Menu-images-4.jpg", "PO_Menu-images-5.jpg", "PO_Menu-images-6.jpg", "PO_Menu-images-7.jpg",
                    "PO_Menu-images-8.jpg", "PO_Menu-images-9.jpg"
                ]
            },
            {
                vendor: "Village Cook",
                files: [
                    "Village_Cook_Menu-images-0.jpg", "Village_Cook_Menu-images-1.jpg", "Village_Cook_Menu-images-2.jpg",
                    "Village_Cook_Menu-images-3.jpg", "Village_Cook_Menu-images-4.jpg"
                ]
            }
        ];

        window.setupAppLogic = (currentUserId) => {
            const menuDisplay = document.getElementById('menu-display');
            const menuVendorSelect = document.getElementById('menu-vendor-select');
            const orderSourceSelect = document.getElementById('order-source');
            const orderForm = document.getElementById('advance-order-form');
            const statusMessage = document.getElementById('submission-status');
            const modal = document.getElementById('status-modal');
            const modalText = document.getElementById('modal-text');
            const closeModalBtn = document.getElementById('close-modal');

            // Populate Vendor Selectors
            menus.forEach(menu => {
                const optionMenu = document.createElement('option');
                optionMenu.value = menu.vendor;
                optionMenu.textContent = menu.vendor;
                menuVendorSelect.appendChild(optionMenu);

                const optionOrder = optionMenu.cloneNode(true);
                orderSourceSelect.appendChild(optionOrder);
            });

            // Function to display the selected menu files
            const renderMenuFiles = (vendorName) => {
                const menu = menus.find(m => m.vendor === vendorName);
                if (menu) {
                    menuDisplay.innerHTML = `
                        <p class="text-sm italic text-gray-500 mb-2">
                            Note: The actual images are not displayed, but the filenames confirm the new .jpg format.
                        </p>
                        <ul class="space-y-1 list-disc list-inside text-sm">
                            ${menu.files.map(file => `<li>${file}</li>`).join('')}
                        </ul>
                    `;
                } else {
                    menuDisplay.innerHTML = '<p class="text-gray-500">Please select a vendor to view the file names.</p>';
                }
            };

            // Event Listener for Menu Vendor Selection
            menuVendorSelect.addEventListener('change', (e) => {
                renderMenuFiles(e.target.value);
            });

            // Initial render
            renderMenuFiles(menuVendorSelect.value);

            // Submission handler
            orderForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!isAuthReady || !currentUserId) {
                    showModal('Authentication not complete. Please wait a moment and try again.', 'error');
                    return;
                }

                const formData = new FormData(orderForm);
                const orderData = {
                    vendor: formData.get('order-source'), // New field based on user request
                    customerName: formData.get('customer-name'),
                    orderDate: formData.get('order-date'),
                    notes: formData.get('notes'),
                    userId: currentUserId,
                    timestamp: serverTimestamp()
                };

                try {
                    const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/advance_orders`, crypto.randomUUID());
                    await setDoc(docRef, orderData);
                    showModal('Order submitted successfully! Your order for ' + orderData.vendor + ' has been saved.', 'success');
                    orderForm.reset();
                } catch (error) {
                    console.error("Error submitting order:", error);
                    showModal(`Failed to submit order: ${error.message}`, 'error');
                }
            });

            // Modal functionality
            function showModal(message, type) {
                modalText.textContent = message;
                modal.classList.remove('hidden');
                if (type === 'success') {
                    modalText.classList.remove('text-red-600');
                    modalText.classList.add('text-green-600');
                } else {
                    modalText.classList.remove('text-green-600');
                    modalText.classList.add('text-red-600');
                }
            }

            closeModalBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            // Live Updates (Example: listen to the user's own orders)
            // You can uncomment this section if you want to display the user's submitted orders in real-time.
            /*
            const ordersRef = collection(db, `artifacts/${appId}/users/${currentUserId}/advance_orders`);
            onSnapshot(query(ordersRef), (snapshot) => {
                const ordersList = document.getElementById('past-orders');
                ordersList.innerHTML = '';
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.textContent = `${data.vendor} order by ${data.customerName} on ${data.orderDate}.`;
                    li.className = 'border-b py-2 text-sm';
                    ordersList.appendChild(li);
                });
            });
            */
        };
    </script>
    <style>
        .font-inter { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-50 font-inter p-4 sm:p-8">

    <!-- Header and Status -->
    <header class="mb-8 border-b pb-4">
        <h1 class="text-3xl font-extrabold text-blue-800 tracking-tight">Advance Order Portal</h1>
        <p class="text-gray-600 mt-1">Easily view menus and place your advance order.</p>
        <div class="mt-2 text-xs text-gray-500 flex items-center gap-4">
            <span id="app-status" class="font-medium text-green-500">App Ready</span>
            <span>User ID: <span id="user-id-display" class="font-mono text-xs bg-gray-200 px-2 py-0.5 rounded">Loading...</span></span>
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- 1. Menu Viewer (Left Column) -->
        <section class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg h-fit">
            <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">Menu File Viewer</h2>

            <div class="mb-4">
                <label for="menu-vendor-select" class="block text-sm font-medium text-gray-700 mb-1">Select Vendor Menu to View Filenames:</label>
                <select id="menu-vendor-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <!-- Options populated by JS -->
                </select>
            </div>

            <div id="menu-display" class="bg-gray-100 p-4 rounded-lg border border-dashed border-gray-300">
                <!-- Menu file names rendered here -->
            </div>
            <p class="mt-4 text-xs text-red-500 italic">
                *File structure update confirmed: All menus are now listed in **.jpg** format.
            </p>
        </section>

        <!-- 2. Advance Order Form (Right Column) -->
        <section class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold mb-6 text-gray-700 border-b pb-2">Place Advance Order</h2>

            <form id="advance-order-form" class="space-y-6">

                <!-- FIELD: Order Source (Replaced Checkbox) -->
                <div>
                    <label for="order-source" class="block text-sm font-bold text-gray-800 mb-1">
                        Order From (Vendor/Location):
                    </label>
                    <p class="text-xs text-gray-500 mb-2">
                        *This now specifies the exact vendor you are ordering from.*
                    </p>
                    <select id="order-source" name="order-source" required
                            class="mt-1 block w-full pl-3 pr-10 py-2.5 text-base border-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-lg rounded-lg shadow-sm bg-blue-50">
                        <!-- Options populated by JS -->
                    </select>
                </div>

                <!-- FIELD: Customer Name -->
                <div>
                    <label for="customer-name" class="block text-sm font-medium text-gray-700">Customer Name</label>
                    <input type="text" id="customer-name" name="customer-name" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- FIELD: Date -->
                <div>
                    <label for="order-date" class="block text-sm font-medium text-gray-700">Desired Order Date</label>
                    <input type="date" id="order-date" name="order-date" required
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                </div>

                <!-- FIELD: Notes / Specific Order Details -->
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Order Details / Notes</label>
                    <textarea id="notes" name="notes" rows="4" placeholder="e.g., 2 boxes of Goffa Chicken, 1 box of Purple Oven Sans Rival..."
                              class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"></textarea>
                </div>

                <button type="submit"
                        class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                    Submit Advance Order
                </button>
                <div id="submission-status" class="mt-4 text-center"></div>
            </form>
        </section>
    </div>

    <!-- Custom Modal for Alerts (replacing alert()) -->
    <div id="status-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-2xl p-6 max-w-sm w-full">
            <div class="text-center">
                <p id="modal-text" class="text-lg font-semibold mb-4"></p>
                <button id="close-modal" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition">
                    OK
                </button>
            </div>
        </div>
    </div>

</body>
</html>
